#!/usr/bin/env ruby

require 'bundler'

Bundler.require(:default)

require_relative 'lib/spider'
require_relative 'lib/scraper'
require_relative 'lib/datadog'

Datadog.emit_event("Scraper started for #{ARGV.join(',')}",
                   msg_title: '[Craigslist Scraper] Scrape started',
                   priority: 'low',
                   tags: %w{ craigslist_scraper spider_posts } + ARGV.clone
                  )

Typhoeus::Config.user_agent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36'

pg = PG.connect(host:     ENV['DATABASE_HOST'],
                port:     ENV.fetch('DATABASE_PORT', 5432).to_i,
                dbname:   ENV['DATABASE_NAME'],
                user:     ENV['DATABASE_USER'],
                password: ENV['DATABASE_PASS']
               )


pg.prepare('insert', "INSERT INTO posts (url, title, title_ts, body, body_ts, contact_email, contact_phone)
                      VALUES ($1, $2, to_tsvector('english', $2), $3, to_tsvector('english', $3), $4, $5)
                      ON CONFLICT DO NOTHING")

ARGV.each do |city_url|
  p "Crawling #{city_url}"

  Spider.crawl(city_url) do |post_url, post_title, referer|
    already_scrapped = pg.exec_params('SELECT 1 FROM posts WHERE url = $1', [post_url]).first

    next if already_scrapped

    body, email, phone = Scraper.scrape(post_url, { 'Referer' => referer })

    p "Storing data for #{post_url}"

    pg.exec_prepared('insert', [post_url, post_title, body, email, phone])
  end
end

at_exit do
  if $!
    # Looks like an error occurred...

    Datadog.emit_event($!.message,
                       msg_title: '[Craigslist Scraper] An error occurred while spidering',
                       alert_type: 'error',
                       tags: %w{ craigslist_scraper spider_posts } + ARGV.clone
                      )
  else
    Datadog.emit_event("Scraping complete for #{ARGV.join(',')}",
                       msg_title: '[Craigslist Scraper] Scrape finished',
                       alert_type: 'success',
                       tags: %w{ craigslist_scraper spider_posts } + ARGV.clone
                      )
  end
end
