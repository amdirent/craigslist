#!/usr/bin/env ruby

require 'bundler'

Bundler.require(:default, :qualifier)

require 'yaml'

root = File.expand_path(File.dirname(__FILE__))
config = YAML.load_file(File.join(root, 'config.yml'))

Mail.defaults do
  delivery_method :smtp, { address: 'smtp.gmail.com',
                           port: 587,
                           authentication: 'plain',
                           enable_starttls_auto: true,
                           domain:    config['mail']['domain'],
                           user_name: config['mail']['user'],
                           password:  config['mail']['pass']
                         }
end

pg = PG.connect(config['database'])

keywords = %w{ ios
               android
               ruby
               rails
               python
               javascript
               app
               web
               application
               api
               rest
               restful
               programmer
               automate
               automation
               unix
               linux
               shell
               script
             }

tsquery = keywords.join(' | ')

potential_leads = pg.exec_params(<<-SQL, [tsquery])
                                   SELECT p.url, p.title, p.body, p.contact_email, p.contact_phone
                                   FROM (UPDATE posts SET processed = true WHERE NOT processed RETURNING *) p,
                                        to_tsquery($1) query
                                   WHERE p.body_ts @@ query OR p.title_ts @@ query
                                   ORDER BY ts_rank(title_ts, query, 32) DESC, ts_rank(body_ts, query, 32) DESC
                                 SQL

formatted_data = potential_leads.map do |post|
  post_body = post['body'].to_s.sub(/^QR Code.*\n/, '').strip

  <<-HTML
    <p>
      <a href="#{post['url']}">#{post['title']}</a>
      <br />
      #{post_body.gsub(/\s+/, ' ').slice(0, 255)}#{post_body.length > 255 ? '...' : ''}
    </p>
  HTML
end

Mail.deliver do
  to 'chall@amdirent.com, crankin@amdirent.com'
  from 'help@amdirent.com'
  subject "Craigslist Lead Digest for #{Date.today.strftime('%a, %-d %b %Y')}"

  html_part do
    content_type 'text/html; charset=UTF-8'
    body <<-HTML
           <h3>Daily Lead Digest</h3>
           <div style="max-width: 800px">
             <p>Keywords used: #{keywords.join(', ')}</p>
             <br />
             #{formatted_data.join("\n")}
           </div>
         HTML
  end
end
